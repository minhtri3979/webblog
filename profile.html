<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Trang c√° nh√¢n</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="mb-4">
      <a href="home.html" class="btn btn-primary">üè† V·ªÅ trang ch·ªß</a>
    </div>

    <!-- Th√¥ng tin ng∆∞·ªùi d√πng -->
    <div id="userInfo" class="text-center mb-5">
      <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>

    <!-- B√†i vi·∫øt -->
    <h3 class="mb-3">üìù B√†i vi·∫øt</h3>
    <div id="userPosts" class="row g-4">
      <div class="col-12 text-center">
        <div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Loading...</span></div>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem("token");
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get("userId");

    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = atob(base64Url.replace(/-/g, '+').replace(/_/g, '/'));
        return JSON.parse(decodeURIComponent(escape(base64)));
      } catch (e) {
        return null;
      }
    }

    const currentUser = parseJwt(token);
    let isFollowing = false;

    async function loadProfile() {
      try {
        const res = await fetch(`http://localhost:3000/api/users/${userId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ng∆∞·ªùi d√πng");

        const user = await res.json();

        if (currentUser && currentUser.id !== user._id) {
          isFollowing = user.followers?.some(f => {
            return (typeof f === "string" ? f : f._id) === currentUser.id;
          });

          document.getElementById("userInfo").innerHTML = `
            <h2>${user.username}</h2>
            <p class="text-muted">${user.email}</p>
            <p>üë• ${user.followers.length} ng∆∞·ªùi theo d√µi</p>
            <button id="followBtn" class="btn ${isFollowing ? 'btn-outline-danger' : 'btn-success'}">
              ${isFollowing ? 'H·ªßy theo d√µi' : 'Theo d√µi'}
            </button>
          `;
          document.getElementById("followBtn").addEventListener("click", toggleFollow);
        } else {
          document.getElementById("userInfo").innerHTML = `
            <h2>${user.username}</h2>
            <p class="text-muted">${user.email}</p>
            <p>ƒê√¢y l√† b·∫°n</p>
          `;
        }
      } catch (err) {
        console.error("L·ªói:", err);
        document.getElementById("userInfo").innerHTML = "<p class='text-danger'>Kh√¥ng th·ªÉ t·∫£i th√¥ng tin.</p>";
      }
    }

    async function toggleFollow() {
      const method = isFollowing ? "DELETE" : "POST";
      try {
        const res = await fetch(`http://localhost:3000/api/follows/${userId}`, {
          method,
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) throw new Error("L·ªói khi follow/unfollow");

        isFollowing = !isFollowing;
        await loadProfile(); // Refresh UI
      } catch (err) {
        console.error("L·ªói khi follow/unfollow:", err);
        alert("ƒê√£ x·∫£y ra l·ªói.");
      }
    }

    async function loadUserPosts() {
      try {
        const res = await fetch(`http://localhost:3000/api/posts/user/${userId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        const posts = await res.json();
        const postContainer = document.getElementById("userPosts");
        postContainer.innerHTML = "";

        if (!posts.length) {
          postContainer.innerHTML = "<p class='text-muted'>Kh√¥ng c√≥ b√†i vi·∫øt n√†o.</p>";
          return;
        }

        posts.forEach(post => {
          const postHTML = `
            <div class="col-md-6 col-lg-4">
              <div class="card h-100 shadow-sm">
                ${post.image ? `<img src="http://localhost:3000/uploads/${post.image}" class="card-img-top" style="max-height: 300px; object-fit: cover;">` : ''}
                <div class="card-body">
                  <h5 class="card-title">${post.title}</h5>
                  <p class="card-text">${post.content.slice(0, 100)}...</p>
                  <a href="post.html?id=${post._id}" class="btn btn-primary btn-sm">Xem chi ti·∫øt</a>
                </div>
              </div>
            </div>
          `;
          postContainer.innerHTML += postHTML;
        });
      } catch (err) {
        console.error("L·ªói khi t·∫£i b√†i vi·∫øt:", err);
        document.getElementById("userPosts").innerHTML = "<p class='text-danger'>Kh√¥ng th·ªÉ t·∫£i b√†i vi·∫øt.</p>";
      }
    }

    loadProfile();
    loadUserPosts();
  </script>
</body>
</html>
